{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
{% endblock %}

{% block title %}Создать новое блюдо{% endblock %}

{% block body %}
{% load bootstrap %}
<!--modal-->
    <div class="modal fade" id="addIngredientModal" tabindex="-1" aria-labelledby="addIngredientModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addIngredientModalLabel">Добавьте ингредиент</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <form>
            <div class="modal-body">
                <select class="form-select w-50 form-control" aria-label="Ингредиент" style="" id="selectIngredient">
                  <option selected>-----------------</option>
<!--                  <option value="1">Яйцо</option>-->
<!--                  <option value="2">Мука</option>-->
<!--                  <option value="3">Сахар</option>-->
                </select>
                <input type="text" class="form-control" placeholder="количество" aria-label="количество" id="ingredientAmount">
                <select class="form-select form-control" aria-label="измерение" id="selectIngredientUnit">
<!--                  <option selected value="1">миллилитры</option>-->
<!--                  <option value="2">литры</option>-->
                </select>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary"  id="btnAdd">Добавить</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
          </div>
          </form>
        </div>
      </div>
    </div>
  <!--end modal-->
{% endblock %}

{% block content %}

  <form method="POST" action="{% url 'dish_create' %}">
    {% csrf_token %}

      <div class="mb-3">
        <label for="dishName" class="form-label">Наименование блюда</label>
        <input type="text" class="form-control" id="dishName" name="name">
      </div>
      <div class="mb-3">
        <label for="dishDescr" class="form-label">Описание</label>
        <textarea class="form-control" id="dishDescr" name="description" rows="5"></textarea>
      </div>

      <div class="input-group mb-3">
      <span class="input-group-text" id="basic-addon1">ингредиенты</span>
      <button type="button" class="btn btn-outline-secondary"  data-bs-toggle="modal" data-bs-target="#addIngredientModal">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16">
            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"></path>
          </svg>
      </button>
      </div>
      {{ ingredient_formset.management_form }}
      <div class="mb-3" id="ingredientsList">
        <div class="d-none" id="ingredientItem-0">
          <div class="input-group mb-3">
              {% for ingredient_form in ingredient_formset %}
              {{ ingredient_form|bootstrap_horizontal }}
              <!--  {{ ingredient_form.ingredient_name|bootstrap }}
                {{ ingredient_form.ingredient_amount|bootstrap }}
                {{ ingredient_form.ingredient_unit|bootstrap }} -->
              {% endfor %}
           <!-- <input type="text" class="form-control" id="ingredientName-0">
            <input type="text" class="form-control" id="ingredientAmount-0">
            <input type="text" class="form-control" id="ingredientUnit-0"> -->
          </div>
        </div>
      </div>
    <button type="submit" class="btn btn-success">Сохранить</button>
  </form>

<script>
  const ingredientModal = document.getElementById('addIngredientModal');
  const modal = new bootstrap.Modal(ingredientModal);
  let ingredientNum = 0;
  let modalIsShown = 0;
  let ingredientsDict = {};
  let ingredientName = document.getElementById('selectIngredient');
  let ingredientAmount = document.getElementById('ingredientAmount');
  let ingredientUnit = document.getElementById('selectIngredientUnit');

  ingredientName.addEventListener('change', function(e) {
    // add units dynamically
    while (ingredientUnit.options.length > 0){
        ingredientUnit.remove(0);
    };
    ingredientAmount.value = '';

    let units = ingredientsDict[this.value]['units'];
    for (i = 0;i < units.length;i++){
        let option = document.createElement("option");
        option.text = units[i]['name'];
        option.value = units[i]['id'];
        ingredientUnit.add(option);
    };
  });

  ingredientModal.addEventListener('show.bs.modal', function(e) {
      if (modalIsShown == 1) {return};
      // ajax
      const requestURL = '/ingredient/list_json';
      const xhr = new XMLHttpRequest();
      xhr.responseType = 'json';
      xhr.open('GET', requestURL);
      xhr.onload = () => {
          if (xhr.status !== 200) {
            return;
          }
          ingredientsJson = xhr.response;
          console.log(ingredientsJson);
          console.log(ingredientsJson.length);
          for (let i = 0; i < ingredientsJson.length; i++){
            ingredientsDict[ingredientsJson[i]['id']] = ingredientsJson[i];
            console.log(ingredientsDict);
            let option = document.createElement("option");
            option.text = ingredientsJson[i]['name'];
            option.value = ingredientsJson[i]['id'];
            ingredientName.add(option);
         };
          modalIsShown = 1;
      }
      xhr.send();
  });

  document.getElementById("btnAdd").addEventListener("click", function () {
    // close modal
    // modal.hide();
    // get ingredient id for controls
    ingredientNum = ingredientNum + 1
    // add new ingredient to the ingredient list
    let ingredientsList = document.getElementById('ingredientsList');
    let ingredientItem = ingredientsList.querySelector('#ingredientItem-0');
    let newIngredientItem = ingredientItem.cloneNode(true);
    newIngredientItem.id = `ingredientItem-${ingredientNum}`;
    newIngredientItem.setAttribute('class', 'visible');
    // modify ingredient id in hidden input
    ingredientId = ingredientName.selectedOptions[0].value;
    let newIngredientId = newIngredientItem.querySelector('#ingredientId');
    newIngredientId.value = ingredientId
    newIngredientId.name = `form-${ingredientNum}-ingredient_id`;
    // modify ingredientName input
    let newIngredientName = newIngredientItem.querySelector('#ingredientName');
    newIngredientName.value = ingredientName.selectedOptions[0].label;
    newIngredientName.id = `ingredientName-${ingredientNum}`;
    newIngredientName.name = `form-${ingredientNum}-ingredient_name`;
    // modify ingredientAmount input
    let newIngredientAmount = newIngredientItem.querySelector('#ingredientAmount');
    newIngredientAmount.value = ingredientAmount.value;
    newIngredientAmount.id = `ingredientAmount-${ingredientNum}`;
    newIngredientAmount.name = `form-${ingredientNum}-ingredient_amount`;

    // modify ingredientUnit input
    let newIngredientUnit = newIngredientItem.querySelector('#ingredientUnit');
    newIngredientUnit.value = ingredientUnit.selectedOptions[0].label;
    newIngredientUnit.id = `ingredientUnit-${ingredientNum}`;
    newIngredientUnit.name = `form-${ingredientNum}-ingredient_unit`;

    ingredientsList.appendChild(newIngredientItem);

    // increment total forms. Its needed for django formset
    let totalFormInput = document.getElementById('id_form-TOTAL_FORMS');
    totalFormInput.value = Number(totalFormInput.value) + 1;

  });

</script>
{% endblock %}